name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  release:
    types: [ published ]
  workflow_dispatch:

jobs:
  test:
    name: Test
    uses: ./.github/workflows/reusable-test.yml
    secrets:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  lint:
    name: Lint
    uses: ./.github/workflows/reusable-lint.yml

  security:
    name: Security
    uses: ./.github/workflows/reusable-security.yml

  build:
    name: Build
    needs: [test, lint, security]
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    uses: ./.github/workflows/reusable-build.yml
    permissions:
      packages: write

  notify:
    name: Notify Status
    runs-on: ubuntu-latest
    needs: [test, lint, security]
    if: always()

    steps:
    - name: Notify on success
      if: needs.test.result == 'success' && needs.lint.result == 'success' && needs.security.result == 'success'
      run: |
        echo "✅ CI checks passed successfully!"

    - name: Notify on failure
      if: contains(needs.*.result, 'failure')
      run: |
        echo "❌ One or more CI checks failed:"
        echo "- Tests: ${{ needs.test.result }}"
        echo "- Lint: ${{ needs.lint.result }}"
        echo "- Security: ${{ needs.security.result }}"
        exit 1