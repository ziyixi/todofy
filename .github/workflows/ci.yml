name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  release:
    types: [ published ]
  workflow_dispatch:

jobs:
  test:
    name: Test
    uses: ./.github/workflows/reusable-test.yml
    secrets:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  lint:
    name: Lint
    uses: ./.github/workflows/reusable-lint.yml

  security:
    name: Security
    uses: ./.github/workflows/reusable-security.yml

  integration-test:
    name: Integration Test
    uses: ./.github/workflows/reusable-integration-test.yml

  build:
    name: Build
    needs: [test, lint, security, integration-test]
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    uses: ./.github/workflows/reusable-build.yml
    permissions:
      packages: write

  notify:
    name: Notify Status
    runs-on: ubuntu-latest
    needs: [test, lint, security, integration-test]
    if: always()

    steps:
    - name: Notify on success
      if: needs.integration-test.result == 'success'
      run: |
        echo "✅ CI checks passed successfully!"

    - name: Notify on failure
      if: needs.integration-test.result == 'failure'
      run: |
        echo "❌ CI checks failed!"
        exit 1