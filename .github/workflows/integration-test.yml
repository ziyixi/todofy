name: Docker Integration Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  integration-test:
    name: Docker Integration Tests
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and start containers
        run: |
          docker compose -f docker-compose.test.yml build
          docker compose -f docker-compose.test.yml up -d

      - name: Wait for services to be healthy
        run: |
          echo "Waiting for all services to be healthy..."
          
          # Wait for up to 120 seconds for all services to become healthy
          timeout=120
          elapsed=0
          
          while [ $elapsed -lt $timeout ]; do
            # Check if all services are healthy
            all_healthy=true
            
            for service in todofy-llm-test todofy-todo-test todofy-database-test todofy-test; do
              status=$(docker inspect --format='{{.State.Health.Status}}' $service 2>/dev/null || echo "not_found")
              if [ "$status" != "healthy" ]; then
                all_healthy=false
                echo "  $service: $status"
              else
                echo "  $service: healthy ✓"
              fi
            done
            
            if [ "$all_healthy" = true ]; then
              echo "All services are healthy!"
              break
            fi
            
            echo "Waiting for services... ($elapsed/$timeout seconds)"
            sleep 5
            elapsed=$((elapsed + 5))
          done
          
          if [ $elapsed -ge $timeout ]; then
            echo "Timeout waiting for services to become healthy"
            docker compose -f docker-compose.test.yml logs
            exit 1
          fi

      - name: Test main service health endpoint
        run: |
          echo "Testing main service health endpoint..."
          response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:10003/health)
          if [ "$response" = "200" ]; then
            echo "Health endpoint returned 200 OK ✓"
          else
            echo "Health endpoint returned $response (expected 200)"
            exit 1
          fi
          
          # Also verify the response body
          body=$(curl -s http://localhost:10003/health)
          echo "Health response: $body"
          
          if echo "$body" | grep -q '"status":"healthy"'; then
            echo "Service reports healthy status ✓"
          else
            echo "Service did not report healthy status"
            exit 1
          fi

      - name: Test gRPC service connectivity
        run: |
          echo "Testing gRPC services from main container..."
          
          # Test that the main service can connect to all gRPC services
          # by checking container logs for successful connection messages
          docker logs todofy-test 2>&1 | grep -q "Connected to gRPC services" && \
            echo "Main service connected to gRPC services ✓" || \
            (echo "Main service failed to connect to gRPC services" && docker logs todofy-test && exit 1)
          
          # Verify database was set up successfully
          docker logs todofy-test 2>&1 | grep -q "Database successfully set up" && \
            echo "Database setup confirmed ✓" || \
            (echo "Database setup not confirmed" && docker logs todofy-test && exit 1)

      - name: Show service logs on success
        if: success()
        run: |
          echo "=== Service Logs (Success) ==="
          docker compose -f docker-compose.test.yml logs

      - name: Show service logs on failure
        if: failure()
        run: |
          echo "=== Service Logs (Failure) ==="
          docker compose -f docker-compose.test.yml logs
          
          echo "=== Container Status ==="
          docker ps -a

      - name: Cleanup
        if: always()
        run: |
          docker compose -f docker-compose.test.yml down -v
          docker system prune -f
