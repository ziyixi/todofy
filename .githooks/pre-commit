#!/usr/bin/env bash
# Pre-commit hook: runs golangci-lint on staged Go files.
# Install with: make install-hooks

set -euo pipefail

# Check if golangci-lint is installed
if ! command -v golangci-lint &>/dev/null; then
    echo "‚ùå golangci-lint not found. Install with: make dev-setup"
    exit 1
fi

# Only lint if Go files are staged
STAGED_GO_FILES=$(git diff --cached --name-only --diff-filter=ACM -- '*.go')
if [[ -z "$STAGED_GO_FILES" ]]; then
    exit 0
fi

echo "üîç Running golangci-lint on staged Go files..."

# Collect unique directories containing staged Go files
DIRS=$(echo "$STAGED_GO_FILES" | xargs -I{} dirname {} | sort -u | sed 's|$|/...|')

# Run linter on affected packages
if ! golangci-lint run $DIRS; then
    echo ""
    echo "‚ùå Lint errors found. Fix them before committing."
    echo "   Run 'make lint' to see all issues."
    exit 1
fi

echo "‚úÖ Lint passed."
